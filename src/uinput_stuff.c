#include "uinput_stuff.h"

#define MAX_KEYS 400

static const char * KEY_STRINGS[] = {
    "ESC",
    "1",
    "2",
    "3",
    "4",
    "5",
    "6",
    "7",
    "8",
    "9",
    "0",
    "MINUS",
    "EQUAL",
    "BACKSPACE",
    "TAB",
    "Q",
    "W",
    "E",
    "R",
    "T",
    "Y",
    "U",
    "I",
    "O",
    "P",
    "LEFTBRACE",
    "RIGHTBRACE",
    "ENTER",
    "LEFTCTRL",
    "A",
    "S",
    "D",
    "F",
    "G",
    "H",
    "J",
    "K",
    "L",
    "SEMICOLON",
    "APOSTROPHE",
    "GRAVE",
    "LEFTSHIFT",
    "BACKSLASH",
    "Z",
    "X",
    "C",
    "V",
    "B",
    "N",
    "M",
    "COMMA",
    "DOT",
    "SLASH",
    "RIGHTSHIFT",
    "KPASTERISK",
    "LEFTALT",
    "SPACE",
    "CAPSLOCK",
    "F1",
    "F2",
    "F3",
    "F4",
    "F5",
    "F6",
    "F7",
    "F8",
    "F9",
    "F10",
    "NUMLOCK",
    "SCROLLLOCK",
    "KP7",
    "KP8",
    "KP9",
    "KPMINUS",
    "KP4",
    "KP5",
    "KP6",
    "KPPLUS",
    "KP1",
    "KP2",
    "KP3",
    "KP0",
    "KPDOT",
    "ZENKAKUHANKAKU",
    "102ND",
    "F11",
    "F12",
    "RO",
    "KATAKANA",
    "HIRAGANA",
    "HENKAN",
    "KATAKANAHIRAGANA",
    "MUHENKAN",
    "KPJPCOMMA",
    "KPENTER",
    "RIGHTCTRL",
    "KPSLASH",
    "SYSRQ",
    "RIGHTALT",
    "LINEFEED",
    "HOME",
    "UP",
    "PAGEUP",
    "LEFT",
    "RIGHT",
    "END",
    "DOWN",
    "PAGEDOWN",
    "INSERT",
    "DELETE",
    "MACRO",
    "MUTE",
    "VOLUMEDOWN",
    "VOLUMEUP",
    "POWER",
    "KPEQUAL",
    "KPPLUSMINUS",
    "PAUSE",
    "SCALE",
    "KPCOMMA",
    "HANGEUL",
    "HANGUEL",
    "HANJA",
    "YEN",
    "LEFTMETA",
    "RIGHTMETA",
    "COMPOSE",
    "STOP",
    "AGAIN",
    "PROPS",
    "UNDO",
    "FRONT",
    "COPY",
    "OPEN",
    "PASTE",
    "FIND",
    "CUT",
    "HELP",
    "MENU",
    "CALC",
    "SETUP",
    "SLEEP",
    "WAKEUP",
    "FILE",
    "SENDFILE",
    "DELETEFILE",
    "XFER",
    "PROG1",
    "PROG2",
    "WWW",
    "MSDOS",
    "COFFEE",
    "SCREENLOCK",
    "DIRECTION",
    "CYCLEWINDOWS",
    "MAIL",
    "BOOKMARKS",
    "COMPUTER",
    "BACK",
    "FORWARD",
    "CLOSECD",
    "EJECTCD",
    "EJECTCLOSECD",
    "NEXTSONG",
    "PLAYPAUSE",
    "PREVIOUSSONG",
    "STOPCD",
    "RECORD",
    "REWIND",
    "PHONE",
    "ISO",
    "CONFIG",
    "HOMEPAGE",
    "REFRESH",
    "EXIT",
    "MOVE",
    "EDIT",
    "SCROLLUP",
    "SCROLLDOWN",
    "KPLEFTPAREN",
    "KPRIGHTPAREN",
    "NEW",
    "REDO",
    "F13",
    "F14",
    "F15",
    "F16",
    "F17",
    "F18",
    "F19",
    "F20",
    "F21",
    "F22",
    "F23",
    "F24",
    "PLAYCD",
    "PAUSECD",
    "PROG3",
    "PROG4",
    "DASHBOARD",
    "SUSPEND",
    "CLOSE",
    "PLAY",
    "FASTFORWARD",
    "BASSBOOST",
    "PRINT",
    "HP",
    "CAMERA",
    "SOUND",
    "QUESTION",
    "EMAIL",
    "CHAT",
    "SEARCH",
    "CONNECT",
    "FINANCE",
    "SPORT",
    "SHOP",
    "ALTERASE",
    "CANCEL",
    "BRIGHTNESSDOWN",
    "BRIGHTNESSUP",
    "MEDIA",
    "SWITCHVIDEOMODE",
    "KBDILLUMTOGGLE",
    "KBDILLUMDOWN",
    "KBDILLUMUP",
    "SEND",
    "REPLY",
    "FORWARDMAIL",
    "SAVE",
    "DOCUMENTS",
    "BATTERY",
    "BLUETOOTH",
    "WLAN",
    "UWB",
    "UNKNOWN",
    "VIDEO_NEXT",
    "VIDEO_PREV",
    "BRIGHTNESS_CYCLE",
    "BRIGHTNESS_ZERO",
    "DISPLAY_OFF",
    "WWAN",
    "WIMAX",
    "RFKILL",
    "MICMUTE",
    "OK",
    "SELECT",
    "GOTO",
    "CLEAR",
    "POWER2",
    "OPTION",
    "INFO",
    "TIME",
    "VENDOR",
    "ARCHIVE",
    "PROGRAM",
    "CHANNEL",
    "FAVORITES",
    "EPG",
    "PVR",
    "MHP",
    "LANGUAGE",
    "TITLE",
    "SUBTITLE",
    "ANGLE",
    "ZOOM",
    "MODE",
    "KEYBOARD",
    "SCREEN",
    "PC",
    "TV",
    "TV2",
    "VCR",
    "VCR2",
    "SAT",
    "SAT2",
    "CD",
    "TAPE",
    "RADIO",
    "TUNER",
    "PLAYER",
    "TEXT",
    "DVD",
    "AUX",
    "MP3",
    "AUDIO",
    "VIDEO",
    "DIRECTORY",
    "LIST",
    "MEMO",
    "CALENDAR",
    "RED",
    "GREEN",
    "YELLOW",
    "BLUE",
    "CHANNELUP",
    "CHANNELDOWN",
    "FIRST",
    "LAST",
    "AB",
    "NEXT",
    "RESTART",
    "SLOW",
    "SHUFFLE",
    "BREAK",
    "PREVIOUS",
    "DIGITS",
    "TEEN",
    "TWEN",
    "VIDEOPHONE",
    "GAMES",
    "ZOOMIN",
    "ZOOMOUT",
    "ZOOMRESET",
    "WORDPROCESSOR",
    "EDITOR",
    "SPREADSHEET",
    "GRAPHICSEDITOR",
    "PRESENTATION",
    "DATABASE",
    "NEWS",
    "VOICEMAIL",
    "ADDRESSBOOK",
    "MESSENGER",
    "DISPLAYTOGGLE",
    "SPELLCHECK",
    "LOGOFF",
    "DOLLAR",
    "EURO",
    "FRAMEBACK",
    "FRAMEFORWARD",
    "CONTEXT_MENU",
    "MEDIA_REPEAT",
    "10CHANNELSUP",
    "10CHANNELSDOWN",
    "IMAGES",
    "DEL_EOL",
    "DEL_EOS",
    "INS_LINE",
    "DEL_LINE",
    "FN",
    "FN_ESC",
    "FN_F1",
    "FN_F2",
    "FN_F3",
    "FN_F4",
    "FN_F5",
    "FN_F6",
    "FN_F7",
    "FN_F8",
    "FN_F9",
    "FN_F10",
    "FN_F11",
    "FN_F12",
    "FN_1",
    "FN_2",
    "FN_D",
    "FN_E",
    "FN_F",
    "FN_S",
    "FN_B",
    "BRL_DOT1",
    "BRL_DOT2",
    "BRL_DOT3",
    "BRL_DOT4",
    "BRL_DOT5",
    "BRL_DOT6",
    "BRL_DOT7",
    "BRL_DOT8",
    "BRL_DOT9",
    "BRL_DOT10",
    "NUMERIC_0",
    "NUMERIC_1",
    "NUMERIC_2",
    "NUMERIC_3",
    "NUMERIC_4",
    "NUMERIC_5",
    "NUMERIC_6",
    "NUMERIC_7",
    "NUMERIC_8",
    "NUMERIC_9",
    "NUMERIC_STAR",
    "NUMERIC_POUND",
    "CAMERA_FOCUS",
    "WPS_BUTTON",
    "TOUCHPAD_TOGGLE",
    "TOUCHPAD_ON",
    "TOUCHPAD_OFF",
    "CAMERA_ZOOMIN",
    "CAMERA_ZOOMOUT",
    "CAMERA_UP",
    "CAMERA_DOWN",
    "CAMERA_LEFT",
    "CAMERA_RIGHT",
    "ATTENDANT_ON",
    "ATTENDANT_OFF",
    "ATTENDANT_TOGGLE",
    "LIGHTS_TOGGLE",
    "ALS_TOGGLE",
    "MIN_INTERESTING"
};
static const int KEYS[] = { KEY_ESC,
	KEY_1,
	KEY_2,
	KEY_3,
	KEY_4,
	KEY_5,
	KEY_6,
	KEY_7,
	KEY_8,
	KEY_9,
	KEY_0,
	KEY_MINUS,
	KEY_EQUAL,
	KEY_BACKSPACE,
	KEY_TAB,
	KEY_Q,
	KEY_W,
	KEY_E,
	KEY_R,
	KEY_T,
	KEY_Y,
	KEY_U,
	KEY_I,
	KEY_O,
	KEY_P,
	KEY_LEFTBRACE,
	KEY_RIGHTBRACE,
	KEY_ENTER,
	KEY_LEFTCTRL,
	KEY_A,
	KEY_S,
	KEY_D,
	KEY_F,
	KEY_G,
	KEY_H,
	KEY_J,
	KEY_K,
	KEY_L,
	KEY_SEMICOLON,
	KEY_APOSTROPHE,
	KEY_GRAVE,
	KEY_LEFTSHIFT,
	KEY_BACKSLASH,
	KEY_Z,
	KEY_X,
	KEY_C,
	KEY_V,
	KEY_B,
	KEY_N,
	KEY_M,
	KEY_COMMA,
	KEY_DOT,
	KEY_SLASH,
	KEY_RIGHTSHIFT,
	KEY_KPASTERISK,
	KEY_LEFTALT,
	KEY_SPACE,
	KEY_CAPSLOCK,
	KEY_F1,
	KEY_F2,
	KEY_F3,
	KEY_F4,
	KEY_F5,
	KEY_F6,
	KEY_F7,
	KEY_F8,
	KEY_F9,
	KEY_F10,
	KEY_NUMLOCK,
	KEY_SCROLLLOCK,
	KEY_KP7,
	KEY_KP8,
	KEY_KP9,
	KEY_KPMINUS,
	KEY_KP4,
	KEY_KP5,
	KEY_KP6,
	KEY_KPPLUS,
	KEY_KP1,
	KEY_KP2,
	KEY_KP3,
	KEY_KP0,
	KEY_KPDOT,
	KEY_ZENKAKUHANKAKU,
	KEY_102ND,
	KEY_F11,
	KEY_F12,
	KEY_RO,
	KEY_KATAKANA,
	KEY_HIRAGANA,
	KEY_HENKAN,
	KEY_KATAKANAHIRAGANA,
	KEY_MUHENKAN,
	KEY_KPJPCOMMA,
	KEY_KPENTER,
	KEY_RIGHTCTRL,
	KEY_KPSLASH,
	KEY_SYSRQ,
	KEY_RIGHTALT,
	KEY_LINEFEED,
	KEY_HOME,
	KEY_UP,
	KEY_PAGEUP,
	KEY_LEFT,
	KEY_RIGHT,
	KEY_END,
	KEY_DOWN,
	KEY_PAGEDOWN,
	KEY_INSERT,
	KEY_DELETE,
	KEY_MACRO,
	KEY_MUTE,
	KEY_VOLUMEDOWN,
	KEY_VOLUMEUP,
	KEY_POWER,
	KEY_KPEQUAL,
	KEY_KPPLUSMINUS,
	KEY_PAUSE,
	KEY_SCALE,
	KEY_KPCOMMA,
	KEY_HANGEUL,
	KEY_HANGUEL,
	KEY_HANJA,
	KEY_YEN,
	KEY_LEFTMETA,
	KEY_RIGHTMETA,
	KEY_COMPOSE,
	KEY_STOP,
	KEY_AGAIN,
	KEY_PROPS,
	KEY_UNDO,
	KEY_FRONT,
	KEY_COPY,
	KEY_OPEN,
	KEY_PASTE,
	KEY_FIND,
	KEY_CUT,
	KEY_HELP,
	KEY_MENU,
	KEY_CALC,
	KEY_SETUP,
	KEY_SLEEP,
	KEY_WAKEUP,
	KEY_FILE,
	KEY_SENDFILE,
	KEY_DELETEFILE,
	KEY_XFER,
	KEY_PROG1,
	KEY_PROG2,
	KEY_WWW,
	KEY_MSDOS,
	KEY_COFFEE,
	KEY_SCREENLOCK,
	KEY_DIRECTION,
	KEY_CYCLEWINDOWS,
	KEY_MAIL,
	KEY_BOOKMARKS,
	KEY_COMPUTER,
	KEY_BACK,
	KEY_FORWARD,
	KEY_CLOSECD,
	KEY_EJECTCD,
	KEY_EJECTCLOSECD,
	KEY_NEXTSONG,
	KEY_PLAYPAUSE,
	KEY_PREVIOUSSONG,
	KEY_STOPCD,
	KEY_RECORD,
	KEY_REWIND,
	KEY_PHONE,
	KEY_ISO,
	KEY_CONFIG,
	KEY_HOMEPAGE,
	KEY_REFRESH,
	KEY_EXIT,
	KEY_MOVE,
	KEY_EDIT,
	KEY_SCROLLUP,
	KEY_SCROLLDOWN,
	KEY_KPLEFTPAREN,
	KEY_KPRIGHTPAREN,
	KEY_NEW,
	KEY_REDO,
	KEY_F13,
	KEY_F14,
	KEY_F15,
	KEY_F16,
	KEY_F17,
	KEY_F18,
	KEY_F19,
	KEY_F20,
	KEY_F21,
	KEY_F22,
	KEY_F23,
	KEY_F24,
	KEY_PLAYCD,
	KEY_PAUSECD,
	KEY_PROG3,
	KEY_PROG4,
	KEY_DASHBOARD,
	KEY_SUSPEND,
	KEY_CLOSE,
	KEY_PLAY,
	KEY_FASTFORWARD,
	KEY_BASSBOOST,
	KEY_PRINT,
	KEY_HP,
	KEY_CAMERA,
	KEY_SOUND,
	KEY_QUESTION,
	KEY_EMAIL,
	KEY_CHAT,
	KEY_SEARCH,
	KEY_CONNECT,
	KEY_FINANCE,
	KEY_SPORT,
	KEY_SHOP,
	KEY_ALTERASE,
	KEY_CANCEL,
	KEY_BRIGHTNESSDOWN,
	KEY_BRIGHTNESSUP,
	KEY_MEDIA,
	KEY_SWITCHVIDEOMODE,
	KEY_KBDILLUMTOGGLE,
	KEY_KBDILLUMDOWN,
	KEY_KBDILLUMUP,
	KEY_SEND,
	KEY_REPLY,
	KEY_FORWARDMAIL,
	KEY_SAVE,
	KEY_DOCUMENTS,
	KEY_BATTERY,
	KEY_BLUETOOTH,
	KEY_WLAN,
	KEY_UWB,
	KEY_UNKNOWN,
	KEY_VIDEO_NEXT,
	KEY_VIDEO_PREV,
	KEY_BRIGHTNESS_CYCLE,
	KEY_BRIGHTNESS_ZERO,
	KEY_DISPLAY_OFF,
	KEY_WWAN,
	KEY_WIMAX,
	KEY_RFKILL,
	KEY_MICMUTE,
	KEY_OK,
	KEY_SELECT,
	KEY_GOTO,
	KEY_CLEAR,
	KEY_POWER2,
	KEY_OPTION,
	KEY_INFO,
	KEY_TIME,
	KEY_VENDOR,
	KEY_ARCHIVE,
	KEY_PROGRAM,
	KEY_CHANNEL,
	KEY_FAVORITES,
	KEY_EPG,
	KEY_PVR,
	KEY_MHP,
	KEY_LANGUAGE,
	KEY_TITLE,
	KEY_SUBTITLE,
	KEY_ANGLE,
	KEY_ZOOM,
	KEY_MODE,
	KEY_KEYBOARD,
	KEY_SCREEN,
	KEY_PC,
	KEY_TV,
	KEY_TV2,
	KEY_VCR,
	KEY_VCR2,
	KEY_SAT,
	KEY_SAT2,
	KEY_CD,
	KEY_TAPE,
	KEY_RADIO,
	KEY_TUNER,
	KEY_PLAYER,
	KEY_TEXT,
	KEY_DVD,
	KEY_AUX,
	KEY_MP3,
	KEY_AUDIO,
	KEY_VIDEO,
	KEY_DIRECTORY,
	KEY_LIST,
	KEY_MEMO,
	KEY_CALENDAR,
	KEY_RED,
	KEY_GREEN,
	KEY_YELLOW,
	KEY_BLUE,
	KEY_CHANNELUP,
	KEY_CHANNELDOWN,
	KEY_FIRST,
	KEY_LAST,
	KEY_AB,
	KEY_NEXT,
	KEY_RESTART,
	KEY_SLOW,
	KEY_SHUFFLE,
	KEY_BREAK,
	KEY_PREVIOUS,
	KEY_DIGITS,
	KEY_TEEN,
	KEY_TWEN,
	KEY_VIDEOPHONE,
	KEY_GAMES,
	KEY_ZOOMIN,
	KEY_ZOOMOUT,
	KEY_ZOOMRESET,
	KEY_WORDPROCESSOR,
	KEY_EDITOR,
	KEY_SPREADSHEET,
	KEY_GRAPHICSEDITOR,
	KEY_PRESENTATION,
	KEY_DATABASE,
	KEY_NEWS,
	KEY_VOICEMAIL,
	KEY_ADDRESSBOOK,
	KEY_MESSENGER,
	KEY_DISPLAYTOGGLE,
	KEY_SPELLCHECK,
	KEY_LOGOFF,
	KEY_DOLLAR,
	KEY_EURO,
	KEY_FRAMEBACK,
	KEY_FRAMEFORWARD,
	KEY_CONTEXT_MENU,
	KEY_MEDIA_REPEAT,
	KEY_10CHANNELSUP,
	KEY_10CHANNELSDOWN,
	KEY_IMAGES,
	KEY_DEL_EOL,
	KEY_DEL_EOS,
	KEY_INS_LINE,
	KEY_DEL_LINE,
	KEY_FN,
	KEY_FN_ESC,
	KEY_FN_F1,
	KEY_FN_F2,
	KEY_FN_F3,
	KEY_FN_F4,
	KEY_FN_F5,
	KEY_FN_F6,
	KEY_FN_F7,
	KEY_FN_F8,
	KEY_FN_F9,
	KEY_FN_F10,
	KEY_FN_F11,
	KEY_FN_F12,
	KEY_FN_1,
	KEY_FN_2,
	KEY_FN_D,
	KEY_FN_E,
	KEY_FN_F,
	KEY_FN_S,
	KEY_FN_B,
	KEY_BRL_DOT1,
	KEY_BRL_DOT2,
	KEY_BRL_DOT3,
	KEY_BRL_DOT4,
	KEY_BRL_DOT5,
	KEY_BRL_DOT6,
	KEY_BRL_DOT7,
	KEY_BRL_DOT8,
	KEY_BRL_DOT9,
	KEY_BRL_DOT10,
	KEY_NUMERIC_0,
	KEY_NUMERIC_1,
	KEY_NUMERIC_2,
	KEY_NUMERIC_3,
	KEY_NUMERIC_4,
	KEY_NUMERIC_5,
	KEY_NUMERIC_6,
	KEY_NUMERIC_7,
	KEY_NUMERIC_8,
	KEY_NUMERIC_9,
	KEY_NUMERIC_STAR,
	KEY_NUMERIC_POUND,
	KEY_CAMERA_FOCUS,
	KEY_WPS_BUTTON,
	KEY_TOUCHPAD_TOGGLE,
	KEY_TOUCHPAD_ON,
	KEY_TOUCHPAD_OFF,
	KEY_CAMERA_ZOOMIN,
	KEY_CAMERA_ZOOMOUT,
	KEY_CAMERA_UP,
	KEY_CAMERA_DOWN,
	KEY_CAMERA_LEFT,
	KEY_CAMERA_RIGHT,
	KEY_ATTENDANT_ON,
	KEY_ATTENDANT_OFF,
	KEY_ATTENDANT_TOGGLE,
	KEY_LIGHTS_TOGGLE,
	KEY_ALS_TOGGLE,
	KEY_MIN_INTERESTING 
};

static void emit_event( int fd, int type, int code, int val )
{
    struct input_event ev;
    memset(&ev, 0, sizeof ev);
    
    ev.type = type;
    ev.code = code;
    ev.value = val;
    
    // Per documentation, timestamps are ignored.
    ev.time.tv_sec = 0;
    ev.time.tv_usec = 0;
    
    write( fd, &ev, sizeof ev );
}

static void emit_report( int fd )
{
    emit_event( fd, EV_SYN, SYN_REPORT, 0 );
}

void key_press( int fd, int code )
{
    emit_event( fd, EV_KEY, code, 1 );
    emit_report( fd );
}

void key_release( int fd, int code )
{
    emit_event( fd, EV_KEY, code, 0 );
    emit_report( fd );
}

int uinput_open(char*path)
{
    struct uinput_setup usetup;

    int fd = open( path,  O_WRONLY | O_NONBLOCK );
    if (fd > 0)
    {
        memset( &usetup, 0, sizeof usetup );
        
        usetup.id.bustype = BUS_USB;
        usetup.id.vendor = 0x1234;
        usetup.id.product = 0x5678;        
        strcpy( usetup.name, "Kontroller" );
        
        // Set up all possible key down events.
        ioctl( fd, UI_SET_EVBIT, EV_KEY);
        for(int key=0; key<MAX_KEYS; key++)
		{
			if(ioctl(fd, UI_SET_KEYBIT, KEYS[key] ) < 0)
			{
				printf( "ioctl(UI_SET_KEYBIT) failed %d, %d\n", key, KEYS[key] );
			}
		}
        
        ioctl( fd, UI_DEV_SETUP, &usetup );
        ioctl( fd, UI_DEV_CREATE );
    }
    
    return fd;
}

void uinput_close( int fd )
{
    ioctl(fd, UI_DEV_DESTROY);
    close(fd);
}


/**
 * This converts the key name (like "Numeric_Pound" to the constant
 * KEY_NUMERIC_POUND.
 *
 * This returns -1 if it cannot be parsed.
 */
int key_parse( char * keyname )
{
    //size_t length = strlen(keyname);
    for(int i=0; i<MAX_KEYS; i++)
    {
        if (strcasecmp( keyname, KEY_STRINGS[i] ) == 0)
        {
            return KEYS[ i ];
        }
    }
    
    return -1;
}

const char * key_name( int code )
{
    for(int i=0; i<MAX_KEYS; i++)
    {
        if (KEYS[i] == code)
            return KEY_STRINGS[i];
    }
    
    return INVALID_KEY_OR_BUTTON;
}
